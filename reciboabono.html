<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="ticket-title">Recibo de Pago</title>
  <link rel="icon" href="https://github.com/rimedhn/demo/blob/main/Logo.png?raw=true">
  <style>
    body {
      font-family: 'Courier New', monospace;
      width: 300px; max-width: 300px;
      margin: 0 auto; padding: 10px; color: #000; background: #fff; line-height: 1.4;
    }
    .centered { text-align: center; }
    .logo { max-width: 70px; margin: 0 auto 8px; display: block; }
    .dotted { border-top: 1px dotted #000; margin: 10px 0; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { font-size: 0.97em; padding: 2px 0; }
    .table th { border-bottom: 1px dotted #000; }
    .amount { text-align: right; }
    .totals { margin-top: 8px; font-size: 1em; }
    .totals div { margin-bottom: 2px; }
    .totals .total { font-weight: bold; font-size: 1.07em;}
    .small { font-size: 0.87em;}
    @media print {
      body { margin: 0; width: 100%; -webkit-print-color-adjust: exact; print-color-adjust: exact;}
    }
  </style>
</head>
<body>
<div id="ticket-container">
  <div class="centered">
    <img class="logo" id="empresa_logo" src="" alt="Logo">
    <div style="margin-bottom:2px;">
      <div id="empresa_nombre"><strong></strong></div>
      <div class="small">RTN: <span id="empresa_rtn"></span></div>
      <div class="small" id="empresa_direccion"></div>
      <div class="small">Email: <span id="empresa_email"></span></div>
      <div class="small">Tel: <span id="empresa_telefono"></span></div>
    </div>
  </div>
  <div class="dotted"></div>
  <div class="centered"><b>RECIBO DE PAGO</b></div>
  <div class="centered small">Folio: <span id="folio"></span> | <span id="fecha_hora"></span></div>
  <div class="dotted"></div>
  <div class="small"><b>Cliente:</b> <span id="nombre_cliente"></span></div>
  <div class="small"><b>Cajero:</b> <span id="nombre_cajero"></span></div>
  <div class="small"><b>Sucursal:</b> <span id="sucursal"></span></div>
  <div class="small"><b>Caja:</b> <span id="caja"></span></div>
  <div class="small"><b>Observaciones:</b> <span id="observacion"></span></div>
  <div class="dotted"></div>
  <div class="centered small"><b>DETALLE DE PAGO</b></div>
  <table class="table">
    <thead>
      <tr>
        <th>Medio de pago</th>
        <th>Monto</th>
      </tr>
    </thead>
    <tbody id="detalle_medios_pago_body"></tbody>
  </table>
  <div class="dotted"></div>
  <div class="totals">
    <div>Saldo anterior: L <span id="saldo_anterior"></span></div>
    <div class="total">Total pagado: L <span id="total_pago"></span></div>
    <div>Saldo final: L <span id="saldo_final"></span></div>
    <div>Saldo cliente: L <span id="saldo_cliente"></span></div>
  </div>
  <div class="dotted"></div>
  <div class="centered small">Â¡Gracias por su pago!</div>
</div>

<script>
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz9AmvEfr1z31vcbKsDPxDbtitZQMJNf-MI10tb-NcSZaCCyE3w2-3vYBS5ppW_qyhR/exec';

function initRecibo() {
  const urlParams = new URLSearchParams(window.location.search);
  const abonoId = urlParams.get('abonoId');
  if (!abonoId) {
    document.getElementById('ticket-container').innerHTML = '<div class="centered">Error: Falta abonoId</div>';
    return;
  }
  document.getElementById('ticket-container').innerHTML = '<div class="centered">Cargando recibo...</div>';
  fetch(`${APPS_SCRIPT_URL}?abonoId=${encodeURIComponent(abonoId)}`)
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        document.getElementById('ticket-container').innerHTML = '<div class="centered">Error: '+data.error+'</div>';
        return;
      }
      renderTicket(data);
    })
    .catch(err => {
      document.getElementById('ticket-container').innerHTML = '<div class="centered">Error de red: '+err.message+'</div>';
    });
}

function renderTicket(data) {
  document.getElementById('empresa_logo').src = data.empresa_logo;
  document.getElementById('empresa_nombre').innerHTML = `<strong>${data.empresa_nombre||''}</strong>`;
  document.getElementById('empresa_rtn').textContent = data.empresa_rtn||'';
  document.getElementById('empresa_direccion').textContent = data.empresa_direccion||'';
  document.getElementById('empresa_email').textContent = data.empresa_email||'';
  document.getElementById('empresa_telefono').textContent = data.empresa_telefono||'';

  document.getElementById('folio').textContent = data.folio||'';
  document.getElementById('fecha_hora').textContent = data.fecha_hora||'';
  document.getElementById('nombre_cliente').textContent = data.nombre_cliente||'';
  document.getElementById('nombre_cajero').textContent = data.nombre_cajero||'';
  document.getElementById('sucursal').textContent = data.sucursal||'';
  document.getElementById('caja').textContent = data.caja||'';
  document.getElementById('observacion').textContent = data.observacion||'';

  const body = document.getElementById('detalle_medios_pago_body');
  body.innerHTML = '';
  if (data.detalle_medios_pago && data.detalle_medios_pago.length) {
    data.detalle_medios_pago.forEach(item => {
      const tr = document.createElement('tr');
      const td1 = document.createElement('td');
      td1.textContent = item.medio_de_pago;
      const td2 = document.createElement('td');
      td2.textContent = 'L' + item.monto;
      td2.className = 'amount';
      tr.appendChild(td1); tr.appendChild(td2);
      body.appendChild(tr);
    });
  } else {
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 2; td.textContent = 'Sin detalle de pago';
    tr.appendChild(td); body.appendChild(tr);
  }

  document.getElementById('saldo_anterior').textContent = data.saldo_anterior||'0.00';
  document.getElementById('total_pago').textContent = data.total_pago||'0.00';
  document.getElementById('saldo_final').textContent = data.saldo_final||'0.00';
  document.getElementById('saldo_cliente').textContent = data.saldo_cliente||'0.00';

  setTimeout(()=>window.print(), 300);
}

initRecibo();
</script>
</body>
</html>
