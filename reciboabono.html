<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <base target="_top">
  <meta name="viewport" content="width=300, initial-scale=1.0">
  <title id="ticket-title">Recibo de Pago</title>
  <link rel="icon" href="https://github.com/rimedhn/demo/blob/main/Logo.png?raw=true">
  <style>
    body { font-family: 'Courier New', monospace; width: 300px; max-width: 300px; margin: 0 auto; padding: 10px; background: #fff; color: #000; }
    .centered { text-align: center; }
    .logo { max-width: 70px; margin: 0 auto 8px; display: block; }
    .dotted { border-top: 1px dotted #000; margin: 10px 0; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { font-size: 0.97em; padding: 2px 0; }
    .table th { border-bottom: 1px dotted #000; }
    .amount { text-align: right; }
    .totals { margin-top: 8px; font-size: 1em; }
    .totals div { margin-bottom: 2px; }
    .totals .total { font-weight: bold; font-size: 1.07em;}
    .small { font-size: 0.87em;}
    @media print {
      body { margin: 0; width: 100%; -webkit-print-color-adjust: exact; print-color-adjust: exact;}
    }
  </style>
</head>
<body>
<div id="ticket-container">
  <div class="centered">
    <img class="logo" id="empresa_logo" src="https://github.com/rimedhn/demo/blob/main/Logo.png?raw=true" alt="Logo">
    <div style="margin-bottom:2px;">
      <div id="empresa_nombre"><strong>Inv. Honduras City Tours</strong></div>
      <div class="small">RTN: <span id="empresa_rtn">08019009248261</span></div>
      <div class="small" id="empresa_direccion">Aldeas las casitas atrás de la secretaria de seguridad. Tegucigalpa, F. M</div>
      <div class="small">Email: <span id="empresa_email">gerencia@citytourstaxi.com</span></div>
      <div class="small">Tel: <span id="empresa_telefono">2247-7650</span></div>
    </div>
  </div>
  <div class="dotted"></div>
  <div class="centered"><b>RECIBO DE PAGO</b></div>
  <div class="centered small">Folio: <span id="folio"></span> | <span id="fecha_hora"></span></div>
  <div class="dotted"></div>
  <div class="small"><b>Cliente:</b> <span id="nombre_cliente"></span></div>
  <div class="small"><b>Cajero:</b> <span id="nombre_cajero"></span></div>
  <div class="small"><b>Sucursal:</b> <span id="sucursal"></span></div>
  <div class="small"><b>Caja:</b> <span id="caja"></span></div>
  <div class="small"><b>Observaciones:</b> <span id="observacion"></span></div>
  <div class="dotted"></div>
  <div class="centered small"><b>DETALLE DE PAGO</b></div>
  <table class="table">
    <thead>
      <tr>
        <th>Medio de pago</th>
        <th>Monto</th>
      </tr>
    </thead>
    <tbody id="detalle_medios_pago_body"></tbody>
  </table>
  <div class="dotted"></div>
  <div class="totals">
    <div>Saldo anterior: L <span id="saldo_anterior"></span></div>
    <div class="total">Total pagado: L <span id="total_pago"></span></div>
    <div>Saldo final: L <span id="saldo_final"></span></div>
    <div>Saldo cliente: L <span id="saldo_cliente"></span></div>
  </div>
  <div class="dotted"></div>
  <div class="centered small">¡Gracias por su pago!</div>
</div>

<script>
// CONFIGURACIÓN
const SHEET_ID = '1VPdlCZXcHfOGCfdnarxrfyKTNHDQQU9E_ISW_qj66YU';
const URL_GENERAL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Abonos%20ventas`;
const URL_DETALLE = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Abono%20ventas`;

// Función robusta para parsear json envuelto de Google Visualization
function parseGoogleSheetJSON(jsonText) {
  const start = jsonText.indexOf('(');
  const end = jsonText.lastIndexOf(')');
  if (start === -1 || end === -1) throw new Error('Formato de respuesta inesperado');
  const json = JSON.parse(jsonText.substring(start + 1, end));
  const cols = json.table.cols.map(col => col.label.trim());
  return json.table.rows.map(row =>
    Object.fromEntries(row.c.map((cell, i) => [cols[i], cell ? cell.v : ""]))
  );
}

async function fetchRecibo(abonoId) {
  // 1. Carga tabla general
  let general, detalle;
  try {
    let resGeneral = await fetch(URL_GENERAL);
    let txtGeneral = await resGeneral.text();
    let rowsGeneral = parseGoogleSheetJSON(txtGeneral);
    general = rowsGeneral.find(r => String(r["id abono"]) === String(abonoId));
    if (!general) throw new Error("No existe abono con ese id");
    document.getElementById('folio').textContent = general.Folio || "";
    document.getElementById('fecha_hora').textContent = general["Fecha hora"] || "";
    document.getElementById('nombre_cliente').textContent = general.NombreCliente || "";
    document.getElementById('nombre_cajero').textContent = general.NombreCajero || "";
    document.getElementById('sucursal').textContent = general.Sucursal || "";
    document.getElementById('caja').textContent = general.Caja || "";
    document.getElementById('observacion').textContent = general.Observacion || "-";
    document.getElementById('saldo_anterior').textContent = Number(general.SaldoAnterior||0).toFixed(2);
    document.getElementById('total_pago').textContent = Number(general.TotalPago||0).toFixed(2);
    document.getElementById('saldo_final').textContent = Number(general.SaldoFinal||0).toFixed(2);
    document.getElementById('saldo_cliente').textContent = Number(general.SaldoCliente||0).toFixed(2);
  } catch (e) {
    document.getElementById('ticket-container').innerHTML = `<div class="centered">Error cargando datos generales: ${e.message}</div>`;
    return;
  }

  // 2. Carga detalle de medios de pago
  try {
    let resDetalle = await fetch(URL_DETALLE);
    let txtDetalle = await resDetalle.text();
    let rowsDetalle = parseGoogleSheetJSON(txtDetalle);
    let pagos = rowsDetalle.filter(r => String(r["id abono"]) === String(abonoId));
    const body = document.getElementById('detalle_medios_pago_body');
    body.innerHTML = "";
    if (pagos.length) {
      pagos.forEach(item => {
        const tr = document.createElement('tr');
        const td1 = document.createElement('td');
        td1.textContent = item["Medio de pago"] || item["MediodePago"] || "";
        const td2 = document.createElement('td');
        td2.textContent = "L" + Number(item.Monto || 0).toFixed(2);
        td2.className = 'amount';
        tr.appendChild(td1); tr.appendChild(td2);
        body.appendChild(tr);
      });
    } else {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 2; td.textContent = 'Sin detalle de pago';
      tr.appendChild(td); body.appendChild(tr);
    }
    setTimeout(()=>window.print(), 300);
  } catch (e) {
    document.getElementById('ticket-container').innerHTML = `<div class="centered">Error cargando detalle de pago: ${e.message}</div>`;
  }
}

// INICIO
(function() {
  const urlParams = new URLSearchParams(window.location.search);
  const abonoId = urlParams.get('abonoId');
  if (!abonoId) {
    document.getElementById('ticket-container').innerHTML = '<div class="centered">Error: Falta abonoId</div>';
    return;
  }
  fetchRecibo(abonoId);
})();
</script>
</body>
</html>
